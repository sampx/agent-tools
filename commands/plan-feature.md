---
description: 基于代码库深度分析创建详尽的功能实现计划 (Plan)
---

# 规划新功能 (Plan Feature)

## 功能目标: $ARGUMENTS

## 核心使命

通过系统的代码库分析、外部研究和战略规划，将用户的功能请求转化为**详尽可执行的实现计划 (Implementation Plan)**。

**核心原则**: 
- 我们在规划阶段**绝不编写实现代码**。
- 我们的目标是创建一个富含上下文的实施计划，让执行阶段的 AI Agent 能够**一次性成功实现**。
- 严禁在此阶段使用 `git add .`、`git commit` 等改变版本历史的破坏性/状态修改命令。

**核心理念**: "上下文就是王道"。计划中必须包含实现所需的所有信息：代码模式、必读文档、验证命令等。

---

## 规划流程 (Planning Process)

### Phase 1: 需求理解 (Feature Understanding)

**深度分析特性:**
- 提取要解决的核心问题
- 识别用户价值和业务影响
- 确定功能类型：新功能 / 增强 / 重构 / Bug修复
- 评估复杂度：低 / 中 / 高
- 梳理受影响的系统和组件

如果需求模糊，请在进行到下一步之前向用户提问澄清（如：库的偏好、特定实现方式、架构决策）。

### Phase 2: 代码库情报收集 (Codebase Intelligence Gathering)

> **提示**: 充分利用 `glob`、`grep` 和 `read` 工具并行探索代码库。

**1. 架构与结构分析**
- 定位相关服务、组件的边界与集成点
- 查找需要修改的现有文件（路由、控制器、组件等）
- 定位配置文件（`package.json`, `pyproject.toml` 等）以确定已有依赖
- **禁止自行预设依赖**，以当前项目真实情况为准。

**2. 模式识别 (Pattern Recognition)**
- 在代码库中寻找类似功能的实现作为参考
- 识别并提取项目的编码规范：
  - 命名风格（组件名、API端点、数据库模型）
  - 错误处理和日志记录模式
  - 目录结构规则
- 提取该领域的常见通用模式，**并显式记录需要避免的反模式 (Anti-patterns)**。
- 阅读项目根目录的 `AGENTS.md` 和全局的 `.agents/rules/` 获取特殊约束。

**3. 测试模式分析**
- 确定现有的测试框架和测试组织结构（如 pytest, jest）
- 寻找可供模仿的测试用例（区分单元测试与集成测试模式）
- 记录覆盖率要求和测试标准。

**4. 依赖分析 (Dependency Analysis)**
- 梳理需要用到的相关外部库
- 了解库是如何被集成的（查看 imports、配置）
- 注意库的特定版本和兼容性要求

**5. 集成点分析 (Integration Points)**
- 识别需要修改/注册的已有文件（如 Router、API 注册表、依赖注入容器）
- 分析数据库模型模式及迁移规则（如适用）
- 识别相关的认证与授权拦截器模式。

### Phase 3: 外部研究 (External Research)

如果涉及新库或新 API，优先收集其最新的官方文档要求：
- 查找当前版本的最佳实践
- 收集实现示例和注意避坑点 (Gotchas)
- 在生成的计划中记录具体的文档链接及其特定锚点段落。

### Phase 4: 战略思考 (Deep Strategic Thinking)

在写计划前进行深度思考 (Ultrathink)：
- 新功能如何融入现有架构？
- 关键依赖是什么？操作的先后顺序是什么？
- 哪里最容易出问题？（如：并发、空指针、边界情况）
- 如何全面测试这个功能？是否存在性能与安全隐患？

### Phase 5: 生成计划并输出 (Plan Generation)

根据探索与思考的结果，使用模板生成功能计划文档。

**计划模板**: 参考 `projects/agent-tools/templates/PLAN-template.md` 的结构与要求。该模板提供了计划所需的所有核心章节（从用户故事到验证命令）。

**文件命名与存放位置**:
> **注意**: AI-Toolbox 采用 Monorepo + Submodule 架构，所有规划文件均集中存放以方便统一管理。

1. 定位**主仓库**的根目录。即便你当前处于某个 Submodule 中，计划文件也**必须**写入主仓库的 `.agents/plans/` 目录下（如果不存在则创建）。
2. 文件名必须使用描述性的短名称 (kebab-case)，并在名字前加上子模块或项目前缀（如果在子模块中）。
3. 例如：`.agents/plans/wopal-add-oauth-login.md` 或 `.agents/plans/flex-scheduler-cron-job.md`。

---

## 质量检测标准 (Quality Criteria)

### 1. 上下文完整性 (Context Completeness)
- 识别并记录了所有必要的代码模式。
- 外部库使用附带文档链接和锚点。
- 每个任务都配有可独立执行的验证命令。

### 2. 准备就绪 (Implementation Ready)
- 任何另一位 Agent 甚至人类开发者无需额外上下文即可执行。
- 任务严格按依赖顺序排列（从上到下执行无阻塞）。
- 模式引用包含了具体的文件路径和行号。
- **进度可追踪**: 每个子任务均自带 Checkbox 及状态标识（Pending/In Progress/Completed）。

### 3. 模式一致性 (Pattern Consistency)
- 新任务遵循代码库现有的最佳实践。
- 不重复造轮子，复用现有的工具函数和类型。

---

## 输出与报告 (Report)

创建 Plan 文件后，请向用户简明扼要地报告：
1. **功能概述**：简述解决思路。
2. **文件路径**：输出创建好的 Plan 文件绝对路径。
3. **复杂度与风险**：指出主要的实现难点或风险考量。
4. **信心指数**：评估执行阶段 Agent 能够一次性成功实现该功能的信心分数（例如 8/10）。
5. **后续步骤**：询问用户是否需要审阅该计划，或直接进入执行阶段（如 `/execute`）。
